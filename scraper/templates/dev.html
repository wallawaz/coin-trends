<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ðŸ’±CoinTrendsðŸ’±</title>

    <!-- Latest compiled and minified CSS -->
    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous">
    </script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="../static/wrap.js"></script>
    
    <link rel="stylesheet" type="text/css" href="../static/style.css">

    <!-- BillboardJS -->
    <script src="../static/billboard.js"></script>
    <link href="../static/billboard.css" rel="stylesheet">
    <script type="text/javascript" src="../static/createTable.js"></script>
    <script type="text/javascript" src="../static/createTimeSeries.js"></script>
</head>
<body>
    <script>
        let current_bottom_table = {"columns": [], "rows": []};
        let top_ico_data = [];
        let tsData = [];
        
        var margin = {top: 20, right: 20, bottom: 30, left: 40},
        width = 400 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

        var colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        // set the ranges
        var x = d3.scaleBand()
                .range([0, width]);

        var y = d3.scaleLinear()
                .range([height, 0]);
                
        // append the svg object to the body of the page
        // append a 'group' element to 'svg'
        // moves the 'group' element to the top left margin
        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform", 
                "translate(" + margin.left + "," + margin.top + ")");


        // get the data `(last_post, thread_id, subject, post_count)`
        d3.json("/top_icos", function(error, data) {
            if (error) throw error;
            
            data.top_icos.forEach(function(d) {
                d.post_count = +d.post_count;
                top_ico_data.push(d);
            });
            console.log("foo");

            // Scale the range of the data in the domains
            x.padding(0.5)
                .domain(top_ico_data.map(d => d.subject));
            
            y.domain([0, d3.max(top_ico_data, function(d) { return d.post_count; })]);

            // append the rectangles for the bar chart
            bars = svg.selectAll(".bar")
                .data(top_ico_data)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function(d) { return x(d.subject); })
                .attr("width", x.bandwidth() )
                .attr("y", function(d) { return y(d.post_count); })
                .attr("height", function(d) { return height - y(d.post_count); })
                .attr("fill", function(d) { return colorScale(d.post_count) });
               
            bars.on("click", function(bar) {
                d3.select("#bottom_table_container").select("table").remove();
                d3.json("/posts_by_thread/" + bar.thread_id, function(error, json) {
                    current_bottom_table.columns = json.columns;
                    current_bottom_table.rows = [];
                    json.rows.forEach(r => current_bottom_table.rows.push(r));
                });
                var table, thead, tbody, rows, cells = createTable(current_bottom_table, "bottom_table_container");
            });

            // add the x Axis
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll(".tick text")
                    .call(wrap, x.bandwidth());

            // add the y Axis
            svg.append("g")
                .call(d3.axisLeft(y));
        });

        $.ajax({
            url: "/coin_summary_by_hour",
            type: "GET",
            dataType: "json",
            success: function(data) {
            },
            error: function(req, error) {
                console.log("error: " + $.stringify(req));
            }
        }).then(function(data) {
            tsData.length = 0;
            tsData.push(data.hours);
            data.records.forEach(r => tsData.push(r));
            const tsChart = bb.generate({
                data: {
                    x: "x",
                    columns: tsData,
                    xFormat: "%Y-%m-%d %H:%M:%S"
                },
                axis: {
                    x: {
                        type: "timeseries",
                        tick : {
                           format: "%Y-%m-%d %H:%M:%S"
                        }
                    }
                },
                bindto: "#timeSeriesChart"
            });
        });

    </script>

    <div class="container">
        <div class="flex1">
            <div id="timeSeriesChart"></div>
        </div>
        <div class="flex2">
            <div id="barChart"></div>
            <table border="0" cellpadding="1" style="overflow-y: scroll;">
                <tr>
                    <td><div id="bottom_table_container" class="csvTable"></div></td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>